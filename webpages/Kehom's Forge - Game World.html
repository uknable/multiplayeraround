<!DOCTYPE html>
<!-- saved from url=(0065)http://kehomsforge.com/tutorials/multi/gdMultiplayerSetup/part03/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   
   <title>Kehom's Forge - Game World</title>

   <link rel="stylesheet" type="text/css" href="./Kehom&#39;s Forge - Game World_files/main.css">
   <link rel="stylesheet" type="text/css" href="./Kehom&#39;s Forge - Game World_files/prism.css">
   <link rel="stylesheet" type="text/css" href="./Kehom&#39;s Forge - Game World_files/katex.min.css">
   <script src="./Kehom&#39;s Forge - Game World_files/jquery-3.3.1.min.js.download"></script>
   <script src="./Kehom&#39;s Forge - Game World_files/progress_bar.js.download"></script>
   <script src="./Kehom&#39;s Forge - Game World_files/audio_player.js.download"></script>
   <script src="./Kehom&#39;s Forge - Game World_files/main.js.download"></script></head>
<body>

<div class="page-container">

   <div class="header">
      <a href="http://kehomsforge.com/"><img src="./Kehom&#39;s Forge - Game World_files/title_anvil.png" style="margin: 0; padding: 0"><img src="./Kehom&#39;s Forge - Game World_files/title.png" style="margin: 0; padding: 0"></a>
   </div>

   <div class="col-container clearfix">
      <div class="column sidebar sidenav">
         <a href="http://kehomsforge.com/" class="">Home</a>
         <a href="http://kehomsforge.com/tutorials" class="active">Tutorials</a>
         <a href="http://kehomsforge.com/blog/1/" class="">Blog</a>
         <a href="http://kehomsforge.com/news/1/" class="">News</a>
         <a href="http://kehomsforge.com/contact" class="">Contact</a>
         <a href="http://kehomsforge.com/about" class="">About</a>
         <hr>
      
         <button class="acc_button">
            <img src="./Kehom&#39;s Forge - Game World_files/feed-icon.svg" style="width: 16px; height: 16px; vertical-align: middle;" onerror="this.src=\" feed-icon.png\';'="">
            <span style="">RSS</span>
         </button>
         <div class="acc_panel">
            <a href="http://kehomsforge.com/newsfeed.xml">News</a>
            <a href="http://kehomsforge.com/blogfeed.xml">Blog</a>
            <a href="http://kehomsforge.com/allfeed.xml">News + Blog</a>
         </div>
      
      
      </div>
      

      <div class="column content">
         
         <h2>Part 3 - Game World</h2>
<p>In the previous part we have implemented the code necessary to either create or join a server. At this point, while we can do this, we don’t have much to test, since the game world scene, which is the one opened when the server is created or joined, is completely empty. We will add something into it so we can test things.</p>
<p>The first thing we will do is work on a bare bones heads up display (HUD) that will show the list of connected players. In order to do that we will need some internal peer management code.</p>
<p>After that we will create a “player scene” that will be used to represent a player avatar in the game world.</p>
<h3>Internal Player List</h3>
<p>As mentioned, we will need internal peer management in order to display some information in the “HUD”. This peer management will be done mostly from the <code class="">network.gd</code> script file. It will hold a list of connected players. This list will be dictionary of dictionary entries, where each entry will hold some information regarding each player and the key to each player will be the unique network ID. Through the various events we will keep this list updated across all the connected peers. Which means, we will see how to use some of the remote/rpc functions provided by the Godot engine.</p>
<p>The first thing we will do is create a dictionary that will hold a single player info entry, for the local player. Since this data can be used elsewhere besides the networking code, we will add this into the <code class="">gamestate.gd</code> script. We will work with some basic information for this tutorial, but it should be pretty easy to further expand based on the project needs. Nevertheless, we will hold player name, network id, the path to the “actor” scene and the dominant icon color:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">gamestate.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">var player_info <span class="token operator">=</span> <span class="token punctuation">{</span>
	name <span class="token operator">=</span> <span class="token string">"Player"</span><span class="token punctuation">,</span>                   <span class="token comment"># How this player will be shown within the GUI</span>
	net_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>                        <span class="token comment"># By default everyone receives "server ID"</span>
	actor_path <span class="token operator">=</span> <span class="token string">"res://player.tscn"</span><span class="token punctuation">,</span>  <span class="token comment"># The class used to represent the player in the game world</span>
	char_color <span class="token operator">=</span> Color<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># By default don't modulate the icon color</span>
<span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>Although in the tutorial we won’t deal with different player classes, the code shown here will give the possibility to easily choose one, by just changing the value of the <code class="">gamestate.player_info.actor_path</code> dictionary field. One thing to notice is the default <code class="">net_id</code> value. The server will always have unique network ID equal to <code class="">1</code> so, in a way, we assume the player will be the server.</p>
<p>Ok, now, whenever a client joins a server, we will want everyone to get this information. Also, the new player has to receive the information of everyone already connected in the server. So, the first thing is to declare the list of players within the <code class="">network.gd</code>:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">network.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">var players <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span></span></code></pre>
</div>
<p>We want to populate this list with every connected player and keep this list equal on all machines. To do that we need a function that can be called from a different peer, meaning a <em>remote</em> function. In this function we add a single argument, which should be the player_info dictionary. The intention is to get that information and append into the player list.</p>
<p>As soon as the server is created, we “register” the player itself into the list, which, at that moment, will only contain that player. Once a new player connects into the server, that player must “register” the server’s player into it’s list and itself. The server’s list, already has itself, but must include the new player into it’s dictionary.</p>
<p>In a way, we have to synchronize the lists between the peers. For that, we add some code that will be executed only on the server, which will iterate through the already registered players and send the new player’s information to them. Taking advantage of the loop, we also take the iterated player’s info and send to the newly connected player. Remember, this iteration is done only on the server, which will “distribute” the information throughout the clients.</p>
<p>After leaving this “server only section of the code”, we enter the “general section” which will actually append the new player info into the player list. This is a matter of just assigning the received dictionary into the correct key ID. As mentioned early, we want to display on the HUD the list of connected players. We will use this <code class="">players</code> dictionary in order to populate the HUD with widgets. But, we also need means to indicate that we have to update that widget list because it has changed. In order to do that, we crate yet another signal named <code class="">player_list_changed</code> that will be emitted every time we change the contents of the list. It’s declaration:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">network.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">signal server_created                          <span class="token comment"># when server is successfully created</span>
signal join_success                            <span class="token comment"># When the peer successfully joins a server</span>
signal join_fail                               <span class="token comment"># Failed to join a server</span>
signal player_list_changed                     <span class="token comment"># List of players has been changed</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>Now let’s work on the function that will maintain the player list. Again, we have some code that will be executed only on the server, meant to distribute the player information across the connected players, by calling the function itself but on a remote machine with the <code class="">rpc_id()</code> function. The distribution itself occurs through iterating the players that are already in the list. Within this iteration, notice the fact that we “skip the server” when sending the new player information to the remote machine. The reason for that is that we are already in the server and we get an error if trying to “remote call the local machine”. Moreover, once in the second part of the function, in the “general section”, the server will update it’s internal list with the received data, which is the new player info anyway. After the list is updated we then emit the signal telling about this event. When a peer gets into this function, it will skip the “server only section” and execute only the “append the new player to the player list”. The code to perform those tasks:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">network.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">remote func register_player<span class="token punctuation">(</span>pinfo<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>get_tree<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_network_server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># We are on the server, so distribute the player list information throughout the connected players</span>
		<span class="token keyword">for</span> <span class="token builtin">id</span> <span class="token keyword">in</span> players<span class="token punctuation">:</span>
			<span class="token comment"># Send currently iterated player info to the new player</span>
			rpc_id<span class="token punctuation">(</span>pinfo<span class="token punctuation">.</span>net_id<span class="token punctuation">,</span> <span class="token string">"register_player"</span><span class="token punctuation">,</span> players<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token comment"># Send new player info to currently iterated player, skipping the server (which will get the info shortly)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				rpc_id<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token string">"register_player"</span><span class="token punctuation">,</span> pinfo<span class="token punctuation">)</span>
	
	<span class="token comment"># Now to code that will be executed regardless of being on client or server</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Registering player "</span><span class="token punctuation">,</span> pinfo<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">" ("</span><span class="token punctuation">,</span> pinfo<span class="token punctuation">.</span>net_id<span class="token punctuation">,</span> <span class="token string">") to internal player table"</span><span class="token punctuation">)</span>
	players<span class="token punctuation">[</span>pinfo<span class="token punctuation">.</span>net_id<span class="token punctuation">]</span> <span class="token operator">=</span> pinfo          <span class="token comment"># Create the player entry in the dictionary</span>
	emit_signal<span class="token punctuation">(</span><span class="token string">"player_list_changed"</span><span class="token punctuation">)</span>     <span class="token comment"># And notify that the player list has been changed</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>Obviously we have to initially call this function. The way we will do this follows. Once the client successfully gets connected and after emitting the signal indicating the success, we update its internal <code class="">gamestate.player_info</code> dictionary and then send the information to the server through the <code class="">register_player()</code> function. If you pay close attention to the <code class="">register_player()</code> code, you will probably notice the fact that after the server finishes broadcasting the new <code class="">player_info</code> the new player has got everyone in his/her local list, but not him/herself. To “fix” that, we call this function locally right after requesting the server to distribute the information across the players:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">network.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func _on_connected_to_server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	emit_signal<span class="token punctuation">(</span><span class="token string">"join_success"</span><span class="token punctuation">)</span>
	<span class="token comment"># Update the player_info dictionary with the obtained unique network ID</span>
	gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">.</span>net_id <span class="token operator">=</span> get_tree<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_network_unique_id<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment"># Request the server to register this new player across all connected players</span>
	rpc_id<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"register_player"</span><span class="token punctuation">,</span> gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">)</span>
	<span class="token comment"># And register itself on the local list</span>
	register_player<span class="token punctuation">(</span>gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>The way we are building the list requires that everyone contains themselves on their local player lists. But with this code the server’s player is not part of any list, not even the local one! Of course we have to fix that. Luckily, it’s very simple. We just update the <code class="">create_server()</code> function to call the <code class="">register_player()</code> just after emitting the <code class="">server_created</code> signal:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">network.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func create_server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># Initialize the networking system</span>
	var net <span class="token operator">=</span> NetworkedMultiplayerENet<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token punctuation">)</span>
	
	<span class="token comment"># Try to create the server</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>net<span class="token punctuation">.</span>create_server<span class="token punctuation">(</span>server_info<span class="token punctuation">.</span>used_port<span class="token punctuation">,</span> server_info<span class="token punctuation">.</span>max_players<span class="token punctuation">)</span> <span class="token operator">!=</span> OK<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Failed to create server"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	
	<span class="token comment"># Assign it into the tree</span>
	get_tree<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_network_peer<span class="token punctuation">(</span>net<span class="token punctuation">)</span>
	<span class="token comment"># Tell the server has been created successfully</span>
	emit_signal<span class="token punctuation">(</span><span class="token string">"server_created"</span><span class="token punctuation">)</span>
	<span class="token comment"># Register the server's player in the local player list</span>
	register_player<span class="token punctuation">(</span>gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<h3>Player List HUD</h3>
<p>At this moment we have no means to know if this is working or not. So let’s add some very basic HUD into the game world scene that we will use to display the list of players. So, open the <code class="">game_world.tscn</code> scene and first rename the root node to <code class="">GameWorld</code> then add a <code class="">CanvasLayer</code> into it, renaming to <code class="">HUD</code>. Then add a <code class="">Panel</code> node into the <code class="">HUD</code>, naming it <code class="">PanelPlayerList</code>. With the panel selected, expand the <code class="">Visibility</code> property under the <em>CanvasItem</em> category. In there change the <code class="">SelfModulate</code> alpha to <code class="">0</code> so the panel itself becomes fully transparent but not it’s children.</p>
<p>Now, add a label into the <code class="">PanelPlayerList</code> naming it <code class="">lblLocalPlayer</code>. This label will hold the name of the player on the local machine. Just for the sake of layout testing you can enter any temporary text like <em>LocalPlayerName</em>.</p>
<p>Next add one <code class="">VBoxContainer</code> into the <code class="">PanelPlayerList</code> naming it <code class="">boxList</code>. Each remote player will have one label inside of this box, which we will dynamically spawn/remove. The <code class="">VBoxContainer</code> node is a nice choice here because widgets are placed one bellow the other. We could have used the <code class="">ItemList</code> node but for this tutorial we don’t need it. Alternatively, we could have created a new scene that would be instanced for each player in the list. Again, no need for that in this tutorial.</p>
<p>Now we can move to the scripting. For that, a new one must be created and attached to the <code class="">GameWorld</code> node. Name the file <code class="">game_world.gd</code>. The first thing we will do is use the <code class="">_ready()</code> function to connect an event handler to the <code class="">player_list_changed</code> signal and also update the <code class="">lblLocalPlayer</code> label widget:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">game_world.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func _ready<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># Connect event handler to the player_list_changed signal</span>
	network<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"player_list_changed"</span><span class="token punctuation">,</span> self<span class="token punctuation">,</span> <span class="token string">"_on_player_list_changed"</span><span class="token punctuation">)</span>
	
	<span class="token comment"># Update the lblLocalPlayer label widget to display the local player name</span>
	$HUD<span class="token operator">/</span>PanelPlayerList<span class="token operator">/</span>lblLocalPlayer<span class="token punctuation">.</span>text <span class="token operator">=</span> gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">.</span>name
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>Of course, we have to create the <code class="">_on_player_list_changed()</code> function! So, let’s do that. In it we first delete all child nodes from the <code class="">boxList</code> then repopulate it. This will be a lot easier than trying to remove/append only the relevant data, which would be the ideal (hint if you want to do so: it becomes almost trivial if you add extra arguments to the <code class="">player_list_changed</code> event, namely the <code class="">player_info</code> of the affecting player and a flag indicating if it’s a new player or someone leaving). In the iteration loop notice the fact that we skip the local player since we have a different spot to display that information, which is above the list itself. Also notice how easy it would be to add extra information from the <code class="">player_info</code> dictionary if we wanted to! The code:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">game_world.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func _on_player_list_changed<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># First remove all children from the boxList widget</span>
	<span class="token keyword">for</span> c <span class="token keyword">in</span> $HUD<span class="token operator">/</span>PanelPlayerList<span class="token operator">/</span>boxList<span class="token punctuation">.</span>get_children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		c<span class="token punctuation">.</span>queue_free<span class="token punctuation">(</span><span class="token punctuation">)</span>
	
	<span class="token comment"># Now iterate through the player list creating a new entry into the boxList</span>
	<span class="token keyword">for</span> p <span class="token keyword">in</span> network<span class="token punctuation">.</span>players<span class="token punctuation">:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">.</span>net_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
			var nlabel <span class="token operator">=</span> Label<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token punctuation">)</span>
			nlabel<span class="token punctuation">.</span>text <span class="token operator">=</span> network<span class="token punctuation">.</span>players<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>name
			$HUD<span class="token operator">/</span>PanelPlayerList<span class="token operator">/</span>boxList<span class="token punctuation">.</span>add_child<span class="token punctuation">(</span>nlabel<span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>There is one last detail before we can test this. We have to update the <code class="">player_info</code> dictionary with the correct data. Since we want to update this data from the server creation and server joining code places, we first create a new function meant to perform this task, so we avoid duplicating logic code:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">main_menu.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func set_player_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>!$PanelPlayer<span class="token operator">/</span>txtPlayerName<span class="token punctuation">.</span>text<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">.</span>name <span class="token operator">=</span> $PanelPlayer<span class="token operator">/</span>txtPlayerName<span class="token punctuation">.</span>text
	gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">.</span>char_color <span class="token operator">=</span> $PanelPlayer<span class="token operator">/</span>btColor<span class="token punctuation">.</span>color
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>Again, ideally we should disable both the <code class="">btCreate</code> and <code class="">btJoin</code> buttons if some data is not given, although in this tutorial we are only assigning something to the <code class="">player_info.name</code> if the text field is properly filled. Anyway, on the pressed event of both <em>join</em> and <em>create</em> buttons, prior to dealing with the networking code, we call this new <code class="">set_player_info()</code> function:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">game_world.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func _on_btCreate_pressed<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># Properly set the local player information</span>
	set_player_info<span class="token punctuation">(</span><span class="token punctuation">)</span>
	
	<span class="token comment"># Gather values from the GUI and fill the network.server_info dictionary</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>!$PanelHost<span class="token operator">/</span>txtServerName<span class="token punctuation">.</span>text<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		network<span class="token punctuation">.</span>server_info<span class="token punctuation">.</span>name <span class="token operator">=</span> $PanelHost<span class="token operator">/</span>txtServerName<span class="token punctuation">.</span>text
	network<span class="token punctuation">.</span>server_info<span class="token punctuation">.</span>max_players <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>$PanelHost<span class="token operator">/</span>txtMaxPlayers<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
	network<span class="token punctuation">.</span>server_info<span class="token punctuation">.</span>used_port <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>$PanelHost<span class="token operator">/</span>txtServerPort<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
	
	<span class="token comment"># And create the server, using the function previously added into the code</span>
	network<span class="token punctuation">.</span>create_server<span class="token punctuation">(</span><span class="token punctuation">)</span>


func _on_btJoin_pressed<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># Properly set the local player information</span>
	set_player_info<span class="token punctuation">(</span><span class="token punctuation">)</span>
	
	var port <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>$PanelJoin<span class="token operator">/</span>txtJoinPort<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
	var ip <span class="token operator">=</span> $PanelJoin<span class="token operator">/</span>txtJoinIP<span class="token punctuation">.</span>text
	network<span class="token punctuation">.</span>join_server<span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>It’s time to test the code, which means exporting the project into binary format and opening multiple instances of it. With 3 instances, from the point of view of the “second player”, this is how the list should look like:</p>
<div class="centerblock">
<img src="./Kehom&#39;s Forge - Game World_files/03-plist01.png" class="thumbnail" alt="Player List 1">
</div>
<h3>“Unregistering”</h3>
<p>During the test you may have noticed that closing an instance (other than the server) will not update the player list on any of the peers. Granted, we didn’t add any code to deal with that. For this task we create another remote function. In this case there is no need to separate the code into “server only” and “everyone” sections. All we have to do is remove the relevant player from the <code class="">players</code> list, which will be done based the network ID, which is the key to access it on the dictionary. After that, we emit a signal indicating that the player list has been changed:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">network.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">remote func unregister_player<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Removing player "</span><span class="token punctuation">,</span> players<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">" from internal table"</span><span class="token punctuation">)</span>
	<span class="token comment"># Remove the player from the list</span>
	players<span class="token punctuation">.</span>erase<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span>
	<span class="token comment"># And notify the list has been changed</span>
	emit_signal<span class="token punctuation">(</span><span class="token string">"player_list_changed"</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>We already have the event handler that deals with players being disconnected from the server. Once the server gets this notification we will then call the <code class="">unregister_function()</code> locally (which will update the server’s list) and then we use the <code class="">rpc()</code> function to call this function on all remaining connected players:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">network.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func _on_player_disconnected<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Player "</span><span class="token punctuation">,</span> players<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">" disconnected from server"</span><span class="token punctuation">)</span>
	<span class="token comment"># Update the player tables</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>get_tree<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_network_server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># Unregister the player from the server's list</span>
		unregister_player<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span>
		<span class="token comment"># Then on all remaining peers</span>
		rpc<span class="token punctuation">(</span><span class="token string">"unregister_player"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>Since we are dealing with disconnection events, let’s also work on the one that is emitted to the player that got disconnected. When that happens we have to clear that local player list since that machine is no longer in a multiplayer environment. Also, we reset the <code class="">player_info.net_id</code> to <code class="">1</code>:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">network.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func _on_disconnected_from_server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Disconnected from server"</span><span class="token punctuation">)</span>
	<span class="token comment"># Clear the internal player list</span>
	players<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment"># Reset the player info network ID</span>
	gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">.</span>net_id <span class="token operator">=</span> <span class="token number">1</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>And this is the player list from the point of view of Player 4 after Player 2 has been disconnected from the server (you can simulate that just by closing the relevant game instance window):</p>
<div class="centerblock">
<img src="./Kehom&#39;s Forge - Game World_files/03-plist02.png" class="thumbnail" alt="Player List 2">
</div>
<h3>Player Scene</h3>
<p>We are now synchronizing the player list between the connected peers. But how about we add player controlled actors into the game world and also synchronize them? Let’s do it. First we create a new scene named <code class="">player.tscn</code>. Later on we will create instances of this scene in the game world, one for each connected player. Choose the <code class="">Node2D</code> as root and rename it <em>PlayerRoot</em>. Now drag the default Godot’s <em>icon.png</em> into the scene and then make sure it’s <code class="">transform-&gt;position</code> property is <code class="">x = 0, y = 0</code>. This icon will probably be a bit too big in the game world, so change the scale to <code class="">x = 0.6, y = 0.6</code>.</p>
<p>Ok, now we attach an script to the <code class="">PlayerRoot</code>. Name this new file <code class="">player.gd</code>. At this point it’s entire content should be a single line, <code class="">extends Node2D</code>. We will use this script for two things:</p>
<ol>
<li>Apply the “dominant” color that was chosen at the main menu</li>
<li>Handle movement based on player input</li>
</ol>
<p>Dealing with <code class="">1</code> is extremely simple, as all we have to do is access the <code class="">icon</code> node and apply a color to the <code class="">modulate</code> property. We do this through a new function:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">player.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func set_dominant_color<span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">:</span>
	$icon<span class="token punctuation">.</span>modulate <span class="token operator">=</span> color
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span></span></code></pre>
</div>
<p>As for <code class="">2</code>, we first have to create the input bindings. So open the project settings, then the <code class="">Input Map</code> tab. Add 4 actions named <code class="">move_up</code>, <code class="">move_down</code>, <code class="">move_left</code> and <code class="">move_right</code>. Assign the desired keys for those movements (in my case I have chosen “<em>WASD</em>”). Ok, now we can go back to the script. We use the <code class="">_process(delta)</code> function to poll the action key states on every loop iteration. Whenever a key is pressed we will change a movement vector that, in the end, will be used to move the actor in it’s direction. For that we also need a “movement speed”. So, let’s first declare this variable:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">player.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">var move_speed <span class="token operator">=</span> <span class="token number">300</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span></span></code></pre>
</div>
<p>Of course, tweak this value to whatever you desire. Anyway, let’s work on the <code class="">_process(delta)</code> function now. First we declare the movement vector, initializing it with <em>(0, 0)</em>, so no movement will be performed. Then we poll each one of the action keys. If it’s down, we add/subtract from the vector based on the desired movement direction. When all direction keys are polled, we normalize the vector and then we apply the <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mstyle mathsize="0.9em"><msub><mi>P</mi><mn>2</mn></msub><mo>=</mo><msub><mi>P</mi><mn>1</mn></msub><mo>+</mo><mo>(</mo><mi>m</mi><mi>o</mi><mi>v</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>r</mi><mo>∗</mo><mi>s</mi><mi>p</mi><mi>e</mi><mi>e</mi><mi>d</mi><mo>∗</mo><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>)</mo></mstyle></mrow><annotation encoding="application/x-tex">\small P_2 = P_1 + (movedir * speed * time)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.749997em;vertical-align:-0.135em;"></span><span class="mord sizing reset-size6 size5"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2796266666666667em;"><span style="top:-2.45em;margin-left:-0.13889em;margin-right:0.05555555555555556em;"><span class="pstrut" style="height:2.6em;"></span><span class="sizing reset-size5 size2 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel sizing reset-size6 size5">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.749997em;vertical-align:-0.135em;"></span><span class="mord sizing reset-size6 size5"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2796266666666667em;"><span style="top:-2.45em;margin-left:-0.13889em;margin-right:0.05555555555555556em;"><span class="pstrut" style="height:2.6em;"></span><span class="sizing reset-size5 size2 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.9em;vertical-align:-0.225em;"></span><span class="mopen sizing reset-size6 size5">(</span><span class="mord mathdefault sizing reset-size6 size5">m</span><span class="mord mathdefault sizing reset-size6 size5">o</span><span class="mord mathdefault sizing reset-size6 size5" style="margin-right:0.03588em;">v</span><span class="mord mathdefault sizing reset-size6 size5">e</span><span class="mord mathdefault sizing reset-size6 size5">d</span><span class="mord mathdefault sizing reset-size6 size5">i</span><span class="mord mathdefault sizing reset-size6 size5" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.799992em;vertical-align:-0.174996em;"></span><span class="mord mathdefault sizing reset-size6 size5">s</span><span class="mord mathdefault sizing reset-size6 size5">p</span><span class="mord mathdefault sizing reset-size6 size5">e</span><span class="mord mathdefault sizing reset-size6 size5">e</span><span class="mord mathdefault sizing reset-size6 size5">d</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin sizing reset-size6 size5">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.9em;vertical-align:-0.225em;"></span><span class="mord mathdefault sizing reset-size6 size5">t</span><span class="mord mathdefault sizing reset-size6 size5">i</span><span class="mord mathdefault sizing reset-size6 size5">m</span><span class="mord mathdefault sizing reset-size6 size5">e</span><span class="mclose sizing reset-size6 size5">)</span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mstyle mathsize="0.9em"><msub><mi>P</mi><mn>1</mn></msub></mstyle></mrow><annotation encoding="application/x-tex">\small P_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.749997em;vertical-align:-0.135em;"></span><span class="mord sizing reset-size6 size5"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2796266666666667em;"><span style="top:-2.45em;margin-left:-0.13889em;margin-right:0.05555555555555556em;"><span class="pstrut" style="height:2.6em;"></span><span class="sizing reset-size5 size2 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the current position and <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mstyle mathsize="0.9em"><msub><mi>P</mi><mn>2</mn></msub></mstyle></mrow><annotation encoding="application/x-tex">\small P_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.749997em;vertical-align:-0.135em;"></span><span class="mord sizing reset-size6 size5"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2796266666666667em;"><span style="top:-2.45em;margin-left:-0.13889em;margin-right:0.05555555555555556em;"><span class="pstrut" style="height:2.6em;"></span><span class="sizing reset-size5 size2 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> the resulting position:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">player.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func _process<span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># Initialize the movement vector</span>
	var move_dir <span class="token operator">=</span> Vector2<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	
	<span class="token comment"># Poll the actions keys</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>Input<span class="token punctuation">.</span>is_action_pressed<span class="token punctuation">(</span><span class="token string">"move_up"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># Negative Y will move the actor UP on the screen</span>
		move_dir<span class="token punctuation">.</span>y <span class="token operator">-=</span> <span class="token number">1</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>Input<span class="token punctuation">.</span>is_action_pressed<span class="token punctuation">(</span><span class="token string">"move_down"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># Positive Y will move the actor DOWN on the screen</span>
		move_dir<span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token number">1</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>Input<span class="token punctuation">.</span>is_action_pressed<span class="token punctuation">(</span><span class="token string">"move_left"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># Negative X will move the actor LEFT on the screen</span>
		move_dir<span class="token punctuation">.</span>x <span class="token operator">-=</span> <span class="token number">1</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>Input<span class="token punctuation">.</span>is_action_pressed<span class="token punctuation">(</span><span class="token string">"move_right"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># Positive X will move the actor RIGHT on the screen</span>
		move_dir<span class="token punctuation">.</span>x <span class="token operator">+=</span> <span class="token number">1</span>
	
	<span class="token comment"># Apply the movement formula to obtain the new actor position</span>
	position <span class="token operator">+=</span> move_dir<span class="token punctuation">.</span>normalized<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> move_speed <span class="token operator">*</span> delta
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>If you want to quickly test this, add one instance of this object into the game world scene and try out the movement. Before proceeding remember to remove the player instance from the scene since we will dynamically spawn it.</p>
<h3>Spawning Players</h3>
<p>Now that we have a controllable player actor, we want to spawn it, right? Before doing so, let’s see some of the needed tasks by analyzing the events and what must be done.</p>
<ul>
<li>The server is created. A single instance of the <code class="">player.tscn</code> must be added into the game world, which is owned by the server’s player. Let’s call this player <em>player_server</em>.</li>
<li>A new player (<em>player_2</em>) joins the server. One instance of the player scene must be added into the <em>player_server’s</em> game world but two must be added into <em>player_2’s</em> world, one representing <em>player_server</em> and the other <em>player_2</em>.</li>
<li>A third player (<em>player_3</em>) joins the server. One instance of the player scene must be added into the <em>player_server’s</em> world, one into the <em>player_2’s</em> world and 3 into the <em>player_3’s</em> game world.</li>
</ul>
<p>As you can see, when a player joins the server, all of the already connected players only get a single new instance of the player scene, while the new player must get an instance for each of the already connected players plus it’s own one. We will surely use that information to design the function but there are three other things that we have to take into account.</p>
<p>The first thing is relatively simple, which relates to the spawning position. We need to give an initial position to the player’s avatar otherwise it will be placed at the top-left corner of the screen. We could obtain a random position within the screen size and position the player there. Or we could create some predetermined locations that can be placed when designing the level. With a list of spawning points we can then choose one of them and place the actor at that location.</p>
<p>That said, open the game world scene and add into the root a new <code class="">Node2D</code> node, named <code class="">SpawnPoints</code> which will be used solely for organizing the tree hierarchy. Then add one <code class="">Position2D</code> node into the <code class="">SpawnPoints</code>. This node does not have any visual representation in the game itself, but it does provide a “cross widget” in the editor. With this widget we can reposition the node, becoming an excellent tool to spread several spawn points throughout the level when designing it. Anyway, rename this node to <code class="">1</code>. Now select it and duplicate (<em>ctrl+d</em>). Godot will automatically rename the new node to <code class="">2</code>. Excellent, repeat the duplication until you have 16 spawn points. Then spread those nodes throughout the scene according to your desires. In the editor, this is how mine looks like:</p>
<div class="centerblock">
<img src="./Kehom&#39;s Forge - Game World_files/03-spawnpoints.png" class="thumbnail can-zoom" alt="Spawn Points - In Editor">
</div>
<p>Ok, now we can move into the second thing that we have to take into account. This is a bit more related to how you want to organize your game code. The question here is where will we place the actor spawning code? We could stuff that code directly into the <code class="">network.gd</code>, which surely works great. Well, when first testing the networking that’s where I placed this spawning stuff. In a way this is the first place to come to mind because we want the spawning function to be remote. More about this shortly.</p>
<p>But then, the actor spawning code is somewhat more game specific than “general network”. Maybe we can then add the code within the <code class="">gamestate.gd</code> class. That will certainly work and from the point of view of “game-specific-code” thing, the game state is somewhat like that and can definitely hold this kind of game logic.</p>
<p>The thing is, we are meant to spawn the player scenes within the game world scene. This means that we have to obtain the parent node of the game world. This is also true if we decide to add the spawning code into the <code class="">network.gd</code> class. So, why not add this code directly into the <code class="">game_world.gd</code>? This probably helps a lot with the code since with this we could avoid code to try to obtain and check the validity of the game world scene node as we will already be in it. We also have direct access to the spawn points.</p>
<p>But then again, this is very much related to how you want to organize your game code, so you are free to place the spawning function wherever you prefer, really! In this tutorial, though, we will place the code within the <code class="">game_world.gd</code>.</p>
<p>Now to the third thing that we have to take into account. This relates to the function itself. Does it have to be a <em>remote</em> one? We can surely rely entirely on the local player list in order to spawn the individual player avatars but we have a few problems here, although all of them are solvable.</p>
<p>The first problem comes from the fact that we have to use the <code class="">player_list_changed</code> event in order to help keep the spawned actors in sync. To do that, we also would have to add a few parameters to this event so management becomes easier. By itself that’s not really a problem,  but by the time we effectively connect a function to this event there is a chance the list will already have some entries but will be incomplete. This happens because by the time we are changing from the main menu into the game world the server is already remotely calling the player registration function. In other words, we can’t fully rely on the list being complete when entering the game world scene (in the <code class="">_ready()</code> function) nor fully rely on the <code class="">player_list_changed</code> event to populate the game world. We would have to use both.</p>
<p>While it is still possible to not make a remote function and save some few bandwidth data, this brings some complications that are not really the intention to be shown in this tutorial. Besides that, the amount of data here is not really problematic, unless you are dealing with a massive multiplayer game. That said, we will work with a remote function that will be very similar to the player registration code. That is, the server will remotely call the peers to perform the actor spawning. We do this because the server is always the first to update the player list.</p>
<p>That said, let’s begin working on the function to spawn the player scene for each connected player. As mentioned, we need the <code class="">player_info</code> data to setup the spawned player so we add this as an argument to the function. An additional very helpful argument would be the index of the spawn point so from the server the spawn point will be correctly sent to everyone.</p>
<p>Regarding the spawn point, there is one caveat to be mentioned before showing the code. When spawning the connected player’s avatars into the new peer’s scene, we will use their default spawning points which will probably be incorrect. But later on, when we synchronize their locations those will be corrected. Depending on the latency a player may experience a visual warping of the other players. This can be avoided if we keep track of each player’s position within the server, but that’s not exactly in the scope of this tutorial. Nevertheless, if you want to directly place everyone in the correct place for the new player, from the server code it would be necessary to locate the iterated player’s node and obtain it’s position property.</p>
<p>Ok, on the function’s body, we have a “server only section” that is meant to iterate through the registered players and spread the spawning function call throughout the connected players. In this section we remotely call the spawning function to add each connected player into the new player’s scene as well as adding the new player into everyone else. In this iteration we have to skip the server since the function is already being executed there, not to mention the “remote calling itself” thing that will result in an error message in the console. In the code we use a variable that will be incremented during the loop, which will be used as the spawn index. In a way, the algorithm shown associates each player with an spawn point based on the joining order. Yes, this will potentially spawn multiple players on the same place but then again, this kind of refinement is meant to the polishing phase.</p>
<p>As for the spawning code itself, we first take the player scene path stored in the received <code class="">player_info</code> dictionary. This is where it becomes really easy to customize players avatars, as all we have to do is change the value of the <code class="">actor_path</code> field. Once we have the loaded scene we create an instance of it and then setup the new object, which includes setting the dominant color and it’s position.</p>
<p>There are two more things that we must do. The first thing relates to the <em>network master</em>. This information is necessary to tell who owns that object. By default this is set to <code class="">1</code>, which corresponds to the server. But if the spawned actor does not belong to the server’s player, we have to change it. This is done through the <code class="">set_network_master()</code> function. Shortly we will se how this will affect the object in the game. The second thing relates to the name of the node within the tree. The name is how we will locate the actor at a later moment when retrieving from the tree. And we will need to do that when removing actors from the scene. We will set the name of the node using <code class="">set_name()</code> function and giving the network ID converted into string. Finally, we add the new node object as a child of the game world’s root. The code:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">game_world.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python"><span class="token comment"># Spawns a new player actor, using the provided player_info structure and the given spawn index</span>
remote func spawn_players<span class="token punctuation">(</span>pinfo<span class="token punctuation">,</span> spawn_index<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># If the spawn_index is -1 then we define it based on the size of the player list</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>spawn_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		spawn_index <span class="token operator">=</span> network<span class="token punctuation">.</span>players<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span>get_tree<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_network_server<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> pinfo<span class="token punctuation">.</span>net_id <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># We are on the server and the requested spawn does not belong to the server</span>
		<span class="token comment"># Iterate through the connected players</span>
		var s_index <span class="token operator">=</span> <span class="token number">1</span>      <span class="token comment"># Will be used as spawn index</span>
		<span class="token keyword">for</span> <span class="token builtin">id</span> <span class="token keyword">in</span> network<span class="token punctuation">.</span>players<span class="token punctuation">:</span>
			<span class="token comment"># Spawn currently iterated player within the new player's scene, skipping the new player for now</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">!=</span> pinfo<span class="token punctuation">.</span>net_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
				rpc_id<span class="token punctuation">(</span>pinfo<span class="token punctuation">.</span>net_id<span class="token punctuation">,</span> <span class="token string">"spawn_players"</span><span class="token punctuation">,</span> network<span class="token punctuation">.</span>players<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">,</span> s_index<span class="token punctuation">)</span>
			
			<span class="token comment"># Spawn the new player within the currently iterated player as long it's not the server</span>
			<span class="token comment"># Because the server's list already contains the new player, that one will also get itself!</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				rpc_id<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token string">"spawn_players"</span><span class="token punctuation">,</span> pinfo<span class="token punctuation">,</span> spawn_index<span class="token punctuation">)</span>
			
			s_index <span class="token operator">+=</span> <span class="token number">1</span>
	
	<span class="token comment"># Load the scene and create an instance</span>
	var pclass <span class="token operator">=</span> load<span class="token punctuation">(</span>pinfo<span class="token punctuation">.</span>actor_path<span class="token punctuation">)</span>
	var nactor <span class="token operator">=</span> pclass<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment"># Setup player customization (well, the color)</span>
	nactor<span class="token punctuation">.</span>set_dominant_color<span class="token punctuation">(</span>pinfo<span class="token punctuation">.</span>char_color<span class="token punctuation">)</span>
	<span class="token comment"># And the actor position</span>
	nactor<span class="token punctuation">.</span>position <span class="token operator">=</span> $SpawnPoints<span class="token punctuation">.</span>get_node<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>spawn_index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>position
	<span class="token comment"># If this actor does not belong to the server, change the node name and network master accordingly</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pinfo<span class="token punctuation">.</span>net_id <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		nactor<span class="token punctuation">.</span>set_network_master<span class="token punctuation">(</span>pinfo<span class="token punctuation">.</span>net_id<span class="token punctuation">)</span>
		nactor<span class="token punctuation">.</span>set_name<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>pinfo<span class="token punctuation">.</span>net_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment"># Finally add the actor into the world</span>
	add_child<span class="token punctuation">(</span>nactor<span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>Next we have to call this function. Once in the <code class="">_ready()</code> function we check if we are in the server and, if so, locally call this function. Otherwise, we request the server to execute it which, in turn, will spread the spawning throughout the connected players. Because we are somewhat associating each player with an spawn point based on the join order, when calling the <code class="">spawn_players</code> on the server, we specify <code class="">1</code> as index. Then, we use <code class="">-1</code> for the rest, since we may not have the complete player list at that moment. In this case, the server will take care of correcting the index value and spread it to the players:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">game_world.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func _ready<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># Connect event handler to the player_list_changed signal</span>
	network<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"player_list_changed"</span><span class="token punctuation">,</span> self<span class="token punctuation">,</span> <span class="token string">"_on_player_list_changed"</span><span class="token punctuation">)</span>
	
	<span class="token comment"># Update the lblLocalPlayer label widget to display the local player name</span>
	$HUD<span class="token operator">/</span>PanelPlayerList<span class="token operator">/</span>lblLocalPlayer<span class="token punctuation">.</span>text <span class="token operator">=</span> gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">.</span>name
	
	<span class="token comment"># Spawn the players</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>get_tree<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_network_server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		spawn_players<span class="token punctuation">(</span>gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		rpc_id<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"spawn_players"</span><span class="token punctuation">,</span> gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<h3>Synchronizing the Actors</h3>
<p>If you test the game now, we indeed get the correct amount of player actors spawned within each game window instance. However, if you test the movement, you will be able to control every single icon in the scene! And, there is more, the positions of the actors are not synchronized across the peers. As it turns out, this happens because we are not actually synchronizing those yet! Let’s fix.</p>
<p>Back in <a href="http://kehomsforge.com/tutorials/multi/gdMultiplayerSetup/part01">part 1</a> I have mentioned the <code class="">slave</code> variable as well as the <code class="">rset*()</code> functions. We will use those to “replicate” the desired values across the networked players. We want to synchronize the position of the avatars, so we declare one slave variable meant to do this replication:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">player.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">slave var repl_position <span class="token operator">=</span> Vector2<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span></span></code></pre>
</div>
<p>Next we have to update the <code class="">_process()</code> function. In there we can’t blindly update the actor based on the input. We have to check if that actor belongs to the player! This is done by checking if the local player is the network master, by using <code class="">is_network_master()</code> function. If that’s the case then we can poll the input actions, otherwise we take the position based on the replicated value, <code class="">repl_position</code>:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">player.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func _process<span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>is_network_master<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># Initialize the movement vector</span>
		var move_dir <span class="token operator">=</span> Vector2<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
		
		<span class="token comment"># Poll the actions keys</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>Input<span class="token punctuation">.</span>is_action_pressed<span class="token punctuation">(</span><span class="token string">"move_up"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment"># Negative Y will move the actor UP on the screen</span>
			move_dir<span class="token punctuation">.</span>y <span class="token operator">-=</span> <span class="token number">1</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>Input<span class="token punctuation">.</span>is_action_pressed<span class="token punctuation">(</span><span class="token string">"move_down"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment"># Positive Y will move the actor DOWN on the screen</span>
			move_dir<span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token number">1</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>Input<span class="token punctuation">.</span>is_action_pressed<span class="token punctuation">(</span><span class="token string">"move_left"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment"># Negative X will move the actor LEFT on the screen</span>
			move_dir<span class="token punctuation">.</span>x <span class="token operator">-=</span> <span class="token number">1</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>Input<span class="token punctuation">.</span>is_action_pressed<span class="token punctuation">(</span><span class="token string">"move_right"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment"># Positive X will move the actor RIGHT on the screen</span>
			move_dir<span class="token punctuation">.</span>x <span class="token operator">+=</span> <span class="token number">1</span>
		
		<span class="token comment"># Apply the movement formula to obtain the new actor position</span>
		position <span class="token operator">+=</span> move_dir<span class="token punctuation">.</span>normalized<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> move_speed <span class="token operator">*</span> delta
		
		<span class="token comment"># Replicate the position</span>
		rset<span class="token punctuation">(</span><span class="token string">"repl_position"</span><span class="token punctuation">,</span> position<span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token comment"># Take replicated variables to set current actor state</span>
		position <span class="token operator">=</span> repl_position
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<h3>Despawning</h3>
<p>Fantastic, now we are synchronizing the player’s positions across the connected peers! But, when a player disconnects (other than the server), while we are updating the player list, we are not updating the spawned actors. To fix that we create yet another remote function, meant to remove player scene instances from the game world. Basically, after a player disconnects from the server, we have to iterate through the list of remaining players removing the disconnected player’s actor from their scenes. Yet again we separate the function into a “server only section” and one “everyone section”. From the server we “replicate” the call across all connected players. Then, we perform the actual task of removing the player instance from the scene. To remove the actor, we first have to locate it’s node, which can be done through the name. In this case, the network ID that we have set when spawning the players:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">game_world.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">remote func despawn_player<span class="token punctuation">(</span>pinfo<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>get_tree<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_network_server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">for</span> <span class="token builtin">id</span> <span class="token keyword">in</span> network<span class="token punctuation">.</span>players<span class="token punctuation">:</span>
			<span class="token comment"># Skip disconnecte player and server from replication code</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">==</span> pinfo<span class="token punctuation">.</span>net_id <span class="token operator">|</span><span class="token operator">|</span> <span class="token builtin">id</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				<span class="token keyword">continue</span>
			
			<span class="token comment"># Replicate despawn into currently iterated player</span>
			rpc_id<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token string">"despawn_player"</span><span class="token punctuation">,</span> pinfo<span class="token punctuation">)</span>
	
	<span class="token comment"># Try to locate the player actor</span>
	var player_node <span class="token operator">=</span> get_node<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>pinfo<span class="token punctuation">.</span>net_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>!player_node<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Cannoot remove invalid node from tree"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	
	<span class="token comment"># Mark the node for deletion</span>
	player_node<span class="token punctuation">.</span>queue_free<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>But, we have to call this function when a player disconnects from the server. We are only dealing with this event from the <code class="">network.gd</code> file. What we can do here is this:</p>
<ol>
<li>Create a new signal that will be meant to give the disconnected <code class="">player_info</code> as argument.</li>
<li>If we are the server, we connect to this event and then call the <code class="">despawn_player()</code> function.</li>
<li>The <code class="">despawn_player()</code> is coded in a way to replicate the call across all the connected players.</li>
</ol>
<p>With this, we don’t have to deal with the case of a player being disconnected while the other is just getting into the game world scene and didn’t have time to connect into the event. All that said, let’s declare the new signal, in the <code class="">network.gd</code>:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">network.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">signal server_created                          <span class="token comment"># when server is successfully created</span>
signal join_success                            <span class="token comment"># When the peer successfully joins a server</span>
signal join_fail                               <span class="token comment"># Failed to join a server</span>
signal player_list_changed                     <span class="token comment"># List of players has been changed</span>
signal player_removed<span class="token punctuation">(</span>pinfo<span class="token punctuation">)</span>                   <span class="token comment"># A player has been removed from the list</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>It’s not necessary to add the argument in the signal declaration, but it makes things a lot clearer when studying the code. Now, in the <code class="">unregister_player()</code> function we have to emit this signal. The problem here comes from the fact that our new event requires the <code class="">player_info</code> of the disconnected player, which we have erased. If we invert the call order, we may get errors because our functions are assuming the player list is in the correct state, that is, without the player that has left. So, before erasing the player from the list, we cache it’s info and send that to the new event:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">network.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">remote func unregister_player<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Removing player "</span><span class="token punctuation">,</span> players<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">" from internal table"</span><span class="token punctuation">)</span>
	<span class="token comment"># Cache the player info because it's still necessary for some upkeeping</span>
	var pinfo <span class="token operator">=</span> players<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span>
	<span class="token comment"># Remove the player from the list</span>
	players<span class="token punctuation">.</span>erase<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span>
	<span class="token comment"># And notify the list has been changed</span>
	emit_signal<span class="token punctuation">(</span><span class="token string">"player_list_changed"</span><span class="token punctuation">)</span>
	<span class="token comment"># Emit the signal that is meant to be intercepted only by the server</span>
	emit_signal<span class="token punctuation">(</span><span class="token string">"player_removed"</span><span class="token punctuation">,</span> pinfo<span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>Next we connect a function to this new event only if we are in the server:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">game_world.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func _ready<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># Connect event handler to the player_list_changed signal</span>
	network<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"player_list_changed"</span><span class="token punctuation">,</span> self<span class="token punctuation">,</span> <span class="token string">"_on_player_list_changed"</span><span class="token punctuation">)</span>
	<span class="token comment"># If we are in the server, connect to the event that will deal with player despawning</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>get_tree<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_network_server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		network<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"player_removed"</span><span class="token punctuation">,</span> self<span class="token punctuation">,</span> <span class="token string">"_on_player_removed"</span><span class="token punctuation">)</span>
	
	<span class="token comment"># Update the lblLocalPlayer label widget to display the local player name</span>
	$HUD<span class="token operator">/</span>PanelPlayerList<span class="token operator">/</span>lblLocalPlayer<span class="token punctuation">.</span>text <span class="token operator">=</span> gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">.</span>name
	
	<span class="token comment"># Spawn the players</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>get_tree<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_network_server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		spawn_players<span class="token punctuation">(</span>gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		rpc_id<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"spawn_players"</span><span class="token punctuation">,</span> gamestate<span class="token punctuation">.</span>player_info<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>
<p>Yes, I know we could have reused the server check and connect the function before spawning the actor. I have separated this in the sample code mostly to keep it clear about the different things that are being done within the logic.</p>
<p>We have to create the function, which should only call the <code class="">despawn_player()</code> function. Since we are connecting this function to the event only on the server, we can get away with checking this fact before calling the despawning function:</p>
<div class="cblock-container"><div class="cblock-bar" style="display: none;"><button>Select</button></div>
<div class="centerblock">
<p><code class="">game_world.gd</code></p>
</div>
<pre class="language-python line-numbers"><code class="language-python">func _on_player_removed<span class="token punctuation">(</span>pinfo<span class="token punctuation">)</span><span class="token punctuation">:</span>
	despawn_player<span class="token punctuation">(</span>pinfo<span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span></span></code></pre>
</div>
<p>At this point, there is only one small problem that must be mentioned. If you test the game and watch the output messages in the console, whenever a new player above the <code class="">2</code> count joins the server, a bunch of errors will be given. That happens because there will be quite a few replication code happening but the new peers are still initializing things, not containing the correct actors in the scene yet.</p>
<p>In this tutorial we will ignore this error because it won’t affect the synchronization between the players, however I have to mention it so you know that it’s not your error. Nevertheless, if you really want to remove this error, then things have to be done a little bit differently. First, the replication code must be done individually using the <code class="">rset_id()</code> function, so a lot more control is present when dealing with this part. Next a message or flag must be set to people telling that everything has been fully initialized so that the peer can now receive the replication packets.</p>
<hr>
<p>In this longer part we have done quite a lot, internal player list management, displaying the connected players within the HUD, updating that once something changes, spawning and despawning player actors according to the various connect/disconnect events… all of that synchronized between the connected players, which is the main objective of this tutorial!</p>
<p>We are not done yet, however. In the next part we will go a little further and incorporate some “rudimentary” bot spawning in order to fill the maximum players that can be connected in the game. With that code, we will remove a bot when a new player comes in and (re)add bots when players disconnect from the server.</p>
<p>EDIT: Thanks to NameBrandCerreal for pointing out a typo.</p>


         <hr>
         <div class="centerblock">
            <a href="http://kehomsforge.com/tutorials/multi/gdMultiplayerSetup">Introduction</a><br>

            

               <a href="http://kehomsforge.com/tutorials/multi/gdMultiplayerSetup/part02">Previous</a>

               <a href="http://kehomsforge.com/tutorials/multi/gdMultiplayerSetup/part01" class="bottomnav">01</a>
               <a href="http://kehomsforge.com/tutorials/multi/gdMultiplayerSetup/part02" class="bottomnav">02</a>
               <p class="bottomnav">03</p>
               <a href="http://kehomsforge.com/tutorials/multi/gdMultiplayerSetup/part04" class="bottomnav">04</a>

               <a href="http://kehomsforge.com/tutorials/multi/gdMultiplayerSetup/part04">Next</a>

         </div>

      </div>
   </div>

   <div class="footer">
      ...
   </div>
</div>



</body></html>